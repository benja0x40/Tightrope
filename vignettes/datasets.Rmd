---
title: "Read count datasets"
author: "Benjamin Leblanc"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{datasets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
suppressPackageStartupMessages(library(Tightrope))
# =============================================================================.
#
# -----------------------------------------------------------------------------.
plot_sample <- function(
  x, idx = 1:2, prm = NULL, grp = NULL, grp_order = NULL, ordering = NULL,
  symetric = T, clr = NULL, alpha = 0.1
) {
  rng = matrix(range(x), 2, 2)
  x <- x[, idx]
  xlab <- colnames(x)[1]
  ylab <- colnames(x)[2]
  
  if(symetric) {
    ab  = c(0, 1)
  } else {
    rng = apply(x, 2, range)
    ab  = c(0, 0)
  }
  plot(0, type = 'n', xlab = xlab, ylab = ylab, xlim = rng[, 1], ylim = rng[, 2])
  abline(a = ab[1], b = ab[2], col = grey(0.5))
  if(is.null(clr)) {
    points(x, col = grey(0, alpha = alpha))
    if(! (is.null(prm) | is.null(grp))) {
      grp_clr <- SuperRainbow(nrow(prm), alpha = alpha)
      if(is.null(grp_order)) grp_order <- prm$id
      for(g in grp_order) points(x[grp == g, ], col = grp_clr[g])
    }
  } else {
    points(x, col = clr)
  }
}
```

### Overview

We use simulated reads counts to evaluate the relevance, performance,
robustness and limitiations of our computational normalization method.
The simulations provide multivariate datasets for which we know the true
normalization factor of each sample as well as the detailed statistical
parameters underlying each distinct sub-population of observations.

### Sub-populations

We consider 3 populations of observations in ChIP-seq experiments. The first is
always barely detectable while the second generates background or low
variability read counts in all experimental conditions. The third one shows
variations of gradual intensity in the different experimental conditions.

```{r}
n_obs <- 5000
rs <- SimulatedCounts(n_obs, poorcounts = list(mu = 1.5, sigma = 1.5))
```

```{r, echo=FALSE, results='asis'}
knitr::kable(rs$prm)
```

    TODO:
    here there should be a graph illustrating the distribution of variations
    in each population, in reference to the common average value
    (as computed in the generator function but removing the noise)

```{r Fig1, fig.width=7.15, fig.height=2.65}
layout(matrix(1:3, 1, 3))
par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 1.0, cex.axis = 1.0)
plot_sample(log2(rs$x), idx = c(1, 2), prm = rs$prm, grp = rs$grp, grp_order = 3:1, alpha = 0.05)
plot_sample(log2(rs$x), idx = c(1, 3), prm = rs$prm, grp = rs$grp, grp_order = 3:1, alpha = 0.05)
plot_sample(log2(rs$x), idx = c(3, 2), prm = rs$prm, grp = rs$grp, grp_order = 3:1, alpha = 0.05)
```

### Equations

$\displaystyle \sigma^2 = \frac{1}{N} \sum_{i=1}^{N} (x_i -\mu)^2$ where $\mu$ is the sample mean

