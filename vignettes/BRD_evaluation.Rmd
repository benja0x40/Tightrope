---
title: "BRD evaluation"
author: "Benjamin Leblanc"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{BRD evaluation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Helper functions

```{r, include=FALSE}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
CleanCounts <- function(cnt) {
  chk <- FiniteValues(log2(cnt))
  cnt <- cnt[chk, ]
  cnt
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
ParallelDensity <- function(data, k = 100, spacing = 0.2, jitter = "unif") {
  nc <- ncol(data)
  nr <- nrow(data)
  if(jitter == "triangle") {
    j <- rtriangle(nc * nr, a = -1, b = 1, c = 0)
  } else {
    j <- runif(nc * nr, -1, 1)
  }
  j <- j * (1 - spacing) / 2
  x <- rep(1:nc, each = nr)
  r <- 100 * diff(range(data))
  m <- cbind(r * x + j, as.vector(data))
  m <- cbind(m, knn_density(m, k = k))
  m[, 1] <- x + j
  colnames(m) <- c("x", "y", "d")
  m
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
PlotParallelDensity <- function(x, k, clr = "ry", spacing = 0.2, grid = T, ...) {

  m <- ParallelDensity(x, k, spacing)
  nc <- ncol(x)
  
  lim <- xylim(m[, 1:2], spacing = c(0, 0))
  empty.plot(xlim = lim$x, ylim = lim$y, axes = F, ...)
  if(grid) grid(nx = 0, ny = NULL)
  axis(2)
  axis(1, at = 1:nc, labels = colnames(x), las = 2, tick = F)
  clr <- colorize(m[, 3], mode = "rank", col = clr)
  # clr <- transformColors(clr, S.range = 0.9)
  points(m, cex = 0.5, col = clr)
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
ParallelDensityFast <- function(
  data, nx, ny, spacing = 0.2, jitter = "unif", method = "bin"
) {
  nc <- ncol(data)
  nr <- nrow(data)
  if(jitter == "triangle") {
    j <- rtriangle(nc * nr, a = -1, b = 1, c = 0)
  } else {
    j <- runif(nc * nr, -1, 1)
  }
  j <- j * (1 - spacing) / 2
  x <- rep(1:nc, each = nr)
  h <- cbind(x + j, as.vector(data))
  h <- histogram2D(h, nx = nx, ny = ny, method = method)
  h
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
PlotParallelDensityFast <- function(x, k, clr = "ry", spacing = 0.2, grid = T, method = "bin", ...) {

  nc <- ncol(x)
  nx <- k
  ny <- k
  h <- ParallelDensityFast(x, nx = nx, ny = ny, spacing = spacing, method = method)
  
  lim <- xylim(h$x, rep(h$y, length.out = length(h$x)), spacing = c(0, 0))
  empty.plot(xlim = lim$x, ylim = lim$y, axes = F, ...)
  if(grid) grid(nx = 0, ny = NULL)
  axis(2)
  axis(1, at = 1:nc, labels = colnames(x), las = 2, tick = F)

  cm <- rep(NA, nx * ny)
  chk <- h$z > 0
  cm[chk] <- colorize(h$z[chk], mode = "rank", col = clr)
  cm <- transformColors(cm, S.range = 0.9)
  cm <- matrix(cm, nx, ny)
  image(
    x = h$x, y = h$y, z = matrix(1:length(cm), nrow(cm), ncol(cm)),
    col = cm, add = T
  )
}
```

### Initializations

```{r, include=FALSE}
suppressPackageStartupMessages(library(triangle))
suppressPackageStartupMessages(library(Barbouille))
suppressPackageStartupMessages(library(Tightrope))
```

### Global settings

```{r, include=FALSE}
base_path <- "/Volumes/USB16GB/LT_WORKS/"        # iMac
base_path <- "/media/benjamin/USB16GB/LT_WORKS/" # mistral
```

### Lu_et_al

H3WT versus K36M experiments from Lu et al., 2016.


```{r, eval=FALSE, fig.height=5, fig.width=2.5, message=FALSE, warning=FALSE, include=FALSE}
# =============================================================================.
data_path <- paste0(base_path, "GSE63195_Lu_et_al_2016/_RDATA_/")
# -----------------------------------------------------------------------------.
ROI.LST <- readRDS(paste0(data_path, "ROI.LST.rdata"))
# -----------------------------------------------------------------------------.
mapped_spikein <- readRDS(paste0(data_path, "mapped_spikein.rdata"))
# -----------------------------------------------------------------------------.
Lu_et_al.H3K36me3 <- readRDS(paste0(data_path, "Lu_et_al_H3K36me3.RData"))
Lu_et_al.H3K27me3 <- readRDS(paste0(data_path, "Lu_et_al_H3K27me3.RData"))
# =============================================================================.
# layout(matrix(1:9, 3, 3, byrow = T))
par(mar = c(10, 4, 2, 1), pch = 20, cex.main = 0.9, cex.lab = 0.8, cex.axis = 0.8)
# -----------------------------------------------------------------------------.
roi <- "TSS_ENS"
for(wks_name in c("Lu_et_al.H3K36me3", "Lu_et_al.H3K27me3")) {
  
  message(wks_name)
  wks <- get(wks_name)

  cnt <- CleanCounts(wks$CNT[[roi]]) 
  ldc <- log2(DitherCounts(cnt))
  
  ses <- CleanCounts(wks$CNT[["TSS_ENS"]])
  ses <- CPSES(ses, dither = 5)
  ses <- log2(t(t(2^ldc) * ses))
  
  crx <- match(colnames(cnt), mapped_spikein$lt_id)
  crx <- mapped_spikein$mapped_dm6[crx]
  crx <-  log2(mean(crx) / crx)
  crx <- t(t(ldc) + crx)
  
  brd <- t(t(ldc) + wks$BRD$normfactors)

  PlotParallelDensityFast(crx, k = 300, ylab = "log2(counts)", main = "spike-in")
  PlotParallelDensityFast(brd, k = 300, ylab = "log2(counts)", main = "BRD")
  PlotParallelDensityFast(ses, k = 300, ylab = "log2(counts)", main = "CPSES")
  # empty.plot(axes = F)
}
```

### ESC_BRD

SUZ12 WT + KO cell mix experiments in mouse ESCs.

```{r, eval=FALSE, include=FALSE}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
# fpath <- paste0(base_path, "NextSeq_ESC_BRD_R1_TEST/_RDATA_/mapped_spikein.RData")
# r1 <- readRDS(fpath)
# fpath <- paste0(base_path, "NextSeq_ESC_BRD_R2_TEST/_RDATA_/mapped_spikein.RData")
# r2 <- readRDS(fpath)
# fpath <- paste0(base_path, "NextSeq_ESC_BRD_RDATA/mapped_spikein.rdata")
# saveRDS(rbind(r1, r2), fpath)
# rm(r1, r2)
# =============================================================================.
data_path <- paste0(base_path, "NextSeq_ESC_BRD_RDATA/")
# -----------------------------------------------------------------------------.
mapped_spikein <- readRDS(paste0(data_path, "mapped_spikein.rdata"))
# -----------------------------------------------------------------------------.
ESC_BRD.Suz12    <- readRDS(paste0(data_path, "ESC_BRD_Suz12.RData"))
ESC_BRD.H3K27me3 <- readRDS(paste0(data_path, "ESC_BRD_H3K27me3.RData"))
# -----------------------------------------------------------------------------.
# layout(matrix(1:9, 3, 3, byrow = T))
par(mar = c(6, 4, 2, 1), pch = 20, cex.main = 0.9, cex.lab = 0.8, cex.axis = 0.8)

roi <- "CGI_UCSC"

for(wks_name in c("ESC_BRD.Suz12", "ESC_BRD.H3K27me3")) {
  
  message(wks_name)
  wks <- get(wks_name)

  cnt <- CleanCounts(wks$CNT[[roi]]) 
  ldc <- log2(DitherCounts(cnt))
  
  # ses <- CleanCounts(wks$CNT[["TSS_ENS"]])
  # ses <- CPSES(ses, dither = 5)
  # ses <- log2(t(t(2^ldc) * ses))
  
  crx <- match(colnames(cnt), mapped_spikein$lt_id)
  crx <- mapped_spikein$mapped_dm6[crx]
  crx <-  log2(mean(crx) / crx)
  crx <- t(t(ldc) + crx)
  
  brd <- t(t(ldc) + wks$BRD$normfactors)

  PlotParallelDensity(crx, k = 100, ylab = "log2(counts)", main = "spike-in")
  PlotParallelDensity(brd, k = 100, ylab = "log2(counts)", main = "BRD")
  # PlotParallelDensity(ses, k = 100, ylab = "log2(counts)", main = "CPSES")
  # empty.plot(axes = F)
}
```

### E14_EPZ

EZH2 inhibitor washout experiments in mouse ESCs.

```{r, echo=FALSE, fig.height=5, fig.width=5, message=FALSE, warning=FALSE}
# =============================================================================.
data_path <- paste0(base_path, "NextSeq_E14EPZ/_RDATA_/")
# -----------------------------------------------------------------------------.
ROI.LST <- readRDS(paste0(data_path, "ROI.LST.rdata"))
# -----------------------------------------------------------------------------.
mapped_spikein <- readRDS(paste0(data_path, "mapped_spikein.rdata"))
# -----------------------------------------------------------------------------.
E14_EPZ.me3 <- readRDS(paste0(data_path, "GN_ENS_E14_EPZ_H3K27me3.RData"))
E14_EPZ.me2 <- readRDS(paste0(data_path, "GN_ENS_E14_EPZ_H3K27me2.RData"))
E14_EPZ.me1 <- readRDS(paste0(data_path, "GN_ENS_E14_EPZ_H3K27me1.RData"))
# =============================================================================.
# layout(matrix(1:9, 3, 3, byrow = T))
par(mar = c(10, 4, 2, 1), pch = 20, cex.main = 0.9, cex.lab = 0.8, cex.axis = 0.8)
# -----------------------------------------------------------------------------.
roi <- "CGI_UCSC"
roi <- "TSS_ENS"
for(wks_name in c("E14_EPZ.me3", "E14_EPZ.me2", "E14_EPZ.me1")) {
  
  message(wks_name)
  wks <- get(wks_name)

  cnt <- CleanCounts(wks$CNT[[roi]]) 
  ldc <- log2(DitherCounts(cnt))

  ses <- CleanCounts(wks$CNT[["TSS_ENS"]])
  ses <- CPSES(ses, dither = 5)
  ses <- log2(t(t(2^ldc) * ses))
  
  crx <- match(colnames(cnt), mapped_spikein$lt_id)
  crx <- mapped_spikein$mapped_dm6[crx]
  # crx <- wks$ann$mapped.nbr.dm3
  crx <-  log2(mean(crx) / crx)
  crx <- t(t(ldc) + crx)
  
  brd <- t(t(ldc) + wks$BRD$normfactors)

  PlotParallelDensityFast(crx, k = 300, ylab = "log2(counts)", main = "spike-in")
  PlotParallelDensityFast(brd, k = 300, ylab = "log2(counts)", main = "BRD")
  PlotParallelDensityFast(ses, k = 300, ylab = "log2(counts)", main = "CPSES")
  empty.plot(axes = F)
}
```














```{r, eval=FALSE, include=FALSE}

cgi.me3 <- E14_EPZ.me3$CNT$CGI_UCSC
cgi.me2 <- E14_EPZ.me2$CNT$CGI_UCSC
cgi.me1 <- E14_EPZ.me1$CNT$CGI_UCSC

chk <- FiniteValues(log2(cbind(cgi.me3, cgi.me2, cgi.me1)))

cgi.me3 <- cgi.me3[chk, ]
cgi.me2 <- cgi.me2[chk, ]
cgi.me1 <- cgi.me1[chk, ]

cgi.me3 <- log2(DitherCounts(cgi.me3)) 
cgi.me2 <- log2(DitherCounts(cgi.me2)) 
cgi.me1 <- log2(DitherCounts(cgi.me1)) 

cgi.me3 <- t(t(cgi.me3) + E14_EPZ.me3$BRD$scaling)
cgi.me2 <- t(t(cgi.me2) + E14_EPZ.me2$BRD$scaling)
cgi.me1 <- t(t(cgi.me1) + E14_EPZ.me1$BRD$scaling)


o <- order(rowMeans(cgi.me3[, c(1, 8)]), decreasing = T)

cgi.me3 <- cgi.me3[o, ]
cgi.me2 <- cgi.me2[o, ]
cgi.me1 <- cgi.me1[o, ]

n <- ncol(cgi.me3) - 2
clr <- c("black", rgb(0:n/n, 0.5*n:0/n, n:0/n))

nc <- ncol(cgi.me3)
nr <- nrow(cgi.me3)


layout(matrix(1:9, 3, 3, byrow = T))
par(mar = c(10, 4, 3, 1), pch = 20, cex.lab = 0.9, cex.axis = 0.9)

boxplot(cgi.me3, las = 2, main = "H3K27me3")
abline(h = median(cgi.me3[, 1]))
boxplot(cgi.me2, las = 2, main = "H3K27me2")
abline(h = median(cgi.me2[, 1]))
boxplot(cgi.me1, las = 2, main = "H3K27me1")
abline(h = median(cgi.me1[, 1]))

par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.9, cex.axis = 0.9)

empty.plot(xlim = c(1, nr), ylim = range(cgi.me3))
for(i in 1:nc) points(runmed(cgi.me3[, i], 255), type = "l", col = clr[i])

empty.plot(xlim = c(1, nr), ylim = range(cgi.me2))
for(i in 1:nc) points(runmed(cgi.me2[, i], 255), type = "l", col = clr[i])

empty.plot(xlim = c(1, nr), ylim = range(cgi.me1))
for(i in 1:nc) points(runmed(cgi.me1[, i], 255), type = "l", col = clr[i])

x <- rep(1:nc, each = nr)
x <- x + runif(nc * nr, -1, 1) / 2 # (2 * x + DitherCounts(x)) / 3
y <- rep(1:nr, nc)
y <- 10 * (y + DitherCounts(y)) / (2 * nr)


layout(matrix(1:9, 3, 3, byrow = T))
par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.9, cex.axis = 0.9)
empty.plot(xlim = 1:ncol(cgi.me3), )
plot(x = as.factor(colnames(cgi.me3)), y = rep(NA, ncol(cgi.me3)), type = "n", ylim = range(m[, 2]))

m <- mk_xyd(cgi.me3, k = 200)
plot(m, cex = 0.5, col = colorize(sqrt(m[, 3]), mode = "rank", col = "ry"))

m <- mk_xyd(cgi.me2, k = 200)
plot(m, cex = 0.5, col = colorize(sqrt(m[, 3]), mode = "rank", col = "ry"))

m <- mk_xyd(cgi.me1, k = 200)
plot(m, cex = 0.5, col = colorize(sqrt(m[, 3]), mode = "rank", col = "ry"))

# violin <- function(x, d) {
#   d <- d / max(d)
#   x <- x + d * runif(length(x), -1, 1) / 3
#   x
# }
# 
# x <- rep(1:nc, each = nr)
# 
# z <- as.vector(cgi.me3)
# d <- knn_density(z, k = 50)
# z <- cbind(violin(x, d), z)
# plot(z, cex = 0.5, col = colorize(sqrt(d), mode = "01", col = "ry"))


# library(rgl)

# z <- cbind(x, y, as.vector(cgi.me3))
# plot3d(z[, 1], z[, 2], z[, 3], col = grey(0.3), alpha = 0.1)
# z <- cbind(x, y, as.vector(cgi.me2))
# plot3d(z[, 1], z[, 2], z[, 3], col = grey(0.3), alpha = 0.1)
# z <- cbind(x, y, as.vector(cgi.me1))
# plot3d(z[, 1], z[, 2], z[, 3], col = grey(0.3), alpha = 0.1)


```

