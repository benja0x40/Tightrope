---
title: "Dithered read counts"
author: "Benjamin Leblanc"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{dithering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
suppressPackageStartupMessages(library(Tightrope))
```

### Overview

The distributions of read counts from ChIP-seq experiments result in the
multiplication of identical values in the observations. Dithering these counts
consist in adding noise to the data in order to eliminate the presence of
identical values.

    TODO:
    Here add a short explanation of the dither function.

```{r}
library(Tightrope)
```

Example with a patterned distribution of counts

```{r, message=T, echo=F, warning=FALSE, include=FALSE}
n <- 100000
p <- rep(c(1, 1, 2, 3, 2, 1, 1), length.out = 14)
rs <- RandomCounts(n, d = 2, p = p)
x <- rs$x
y <- DitherCounts(rs$x)
```

```{r, echo=FALSE, fig.width=2.5, fig.height=3.0, message=FALSE, warning=FALSE}
par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.8, cex.axis = 0.8)
plotHistograms(x, y, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
# plotHistograms(x, y = x, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
legend("topright", legend = c("x", "y"), fill = c("darkgrey", "red"), bty = "n", cex = 0.8)

# p <- knn_density(y, k = 200)
# p <- p / max(p)
# clr.prm <- defineColors(thresholds = c(0, 1), colors = grey(1:0), centered = T)
# plot(
#   y, cex = 0.5, col = makeColors(p, parameters = clr.prm), xlim = xylim, ylim = xylim,
#   xlab = "y1", ylab = "y2"
# )
m <- cbind(
  rep(1:14, 14),
  rep(1:14, each = 14)
)
d <- p
d <- d[m[, 1]] + d[m[, 2]]
d <- (d / max(d))^1.5
xylim <- range(x, y)
plot(
  m, cex = 0.5, col = grey(1 - d), xlim = xylim, ylim = xylim,
  xlab = "x1", ylab = "x2"
)
h <- histogram2D(y, plot = T, xlim = xylim, ylim = xylim, method = "bin")
```

Example with counts following a poisson distribution (+ 1 pseudo count)

```{r}
n <- 100000
x <- matrix(1 + rpois(n, lambda = 5), nrow = n / 2, ncol = 2)
y <- DitherCounts(x)
```

```{r, echo=FALSE, fig.width=2.5, fig.height=3.0, message=FALSE, warning=FALSE}
par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.8, cex.axis = 0.8)
plotHistograms(x, y, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
legend("topright", legend = c("x", "y"), fill = c("darkgrey", "red"), bty = "n", cex = 0.8)

xylim <- range(log2(x), log2(y))
plot(
  log2(x), cex = 0.5, col = grey(0, 0.05), xlim = xylim, ylim = xylim,
  xlab = "log2(x1)", ylab = "log2(x2)"
)
abline(a = 2, b = - 1, col = rgb(1, 0.5, 0))
abline(a = 0, b = 1, col = grey(0.5))
plot(
  log2(y), cex = 0.5, col = grey(0, 0.05), xlim = xylim, ylim = xylim,
  xlab = "log2(y1)", ylab = "log2(y2)"
)
abline(a = 2, b = - 1, col = rgb(1, 0.5, 0))
abline(a = 0, b = 1, col = grey(0.5))
```

Example with counts following a negative binomial distribution (+ 1 pseudo count)

```{r}
n <- 100000
x <- matrix(1 + rnbinom(n, mu = 5, size = 2), nrow = n / 2, ncol = 2)
y <- DitherCounts(x)
```

```{r, echo=FALSE, fig.width=2.5, fig.height=3.0, message=FALSE, warning=FALSE}
par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.8, cex.axis = 0.8)
plotHistograms(x, y, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
legend("topright", legend = c("x", "y"), fill = c("darkgrey", "red"), bty = "n", cex = 0.8)

xylim <- range(log2(x), log2(y))
plot(
  log2(x), cex = 0.5, col = grey(0, 0.05), xlim = xylim, ylim = xylim,
  xlab = "log2(x1)", ylab = "log2(x2)"
)
abline(a = 2, b = - 1, col = rgb(1, 0.5, 0))
abline(a = 0, b = 1, col = grey(0.5))
plot(
  log2(y), cex = 0.5, col = grey(0, 0.05), xlim = xylim, ylim = xylim,
  xlab = "log2(y1)", ylab = "log2(y2)"
)
abline(a = 2, b = - 1, col = rgb(1, 0.5, 0))
abline(a = 0, b = 1, col = grey(0.5))
```
