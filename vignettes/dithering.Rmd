---
title: "Dithered read counts"
author: "Benjamin Leblanc"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document:  default
vignette: >
  %\VignetteIndexEntry{dithering}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, message=FALSE, warning=FALSE, include=FALSE}
suppressPackageStartupMessages(library(Tightrope))
```

## Overview

Read counts from genomic experiments like ChIP-seq contain numerous
identical values. Dithering these counts consist in adding noise to the data
in order to eliminate the presence of identical values while avoiding
distortions of the original count distribution.

    TODO:
    Here add a short explanation of the dither function.

```{r include=FALSE}
library(Tightrope)

# =============================================================================.
#
# -----------------------------------------------------------------------------.
PlotHistograms <- function(x, y, bins = 100, xlim = NULL, log = F, rel = F, ...) {

  n <- length(x)

  if(log) {
    x <- log2(x)
    y <- log2(y)
  }

  bins <- bins - 1
  r <- diff(range(x, y, na.rm = T))
  brk <- 0:bins/bins * (1.2 * r) - 0.1 * r + min(x, y, na.rm = T)
  h.x <- hist(x, breaks = brk, plot = F)
  h.y <- hist(y, breaks = brk, plot = F)

  h.x$counts <- h.x$counts / n
  h.y$counts <- h.y$counts / n

  if(rel) {
    chk <- h.x$counts > 0
    h.x$counts[chk] <- with(h.x, counts[chk] / sum(diff(breaks[c(chk, T)]) * counts[chk]))
    chk <- h.y$counts > 0
    h.y$counts[chk] <- with(h.y, counts[chk] / sum(diff(breaks[c(chk, T)]) * counts[chk]))
  }

  if(is.null(xlim)) xlim = range(x, y)
  ylim <- range(h.x$counts, h.y$counts)
  ylim <- min(ylim) + c(0, 1.1 * diff(ylim))
  EmptyPlot(xlim = xlim, ylim = ylim, yaxs = 'i', ...)
  chk <- h.x$counts > 0
  k <- length(h.y$mids)
  x <- c(h.y$mids[1], h.y$mids, h.y$mids[k])
  y <- c(0, h.y$counts, 0)
  polygon(x, y, border = NA, col = rgb(1, 0.6, 0, 0.5))
  chk <- h.y$counts > 0
  points(h.y$mids[chk], h.y$counts[chk], type = 'l', col = rgb(1, 0, 0, 0.75), lwd = 2)
  points(h.x$mids[chk], h.x$counts[chk], type = 'h', lwd = 2, col = grey(0.3))
}

# =============================================================================.
#
# -----------------------------------------------------------------------------.
Plots <- function(x, y) {
  li <- function() {
    # abline(a = 0, b =  1, col = grey(0.5))
    abline(a = 2, b = -1, col = grey(0.5))
    segments( 1, -2, 1, 1, lty = 3)
    segments(-2,  1, 1, 1, lty = 3)
  } 
  
  par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.8, cex.axis = 0.8)
  PlotHistograms(x, y, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
  legend("topright", legend = c("x", "y"), fill = c("darkgrey", "red"), bty = "n", cex = 0.8)
  
  xylim <- range(log2(x), log2(y))
  plot(
    log2(x), xlim = xylim, ylim = xylim,
    pch = 20, cex = 0.5, col = grey(0, 0.05),
    xlab = "log2(x1)", ylab = "log2(x2)", main = "raw"
  )
  li()
  plot(
    log2(y), xlim = xylim, ylim = xylim,
    pch = 20, cex = 0.5, col = grey(0, 0.05),
    xlab = "log2(y1)", ylab = "log2(y2)", main = "dithered"
  )
  li()
}
```

## Examples with count simulations

### Poisson distribution

```{r}
# Number of simulated data points
n <- 30000
# Raw counts (one pseudo count is added to prevent infinite values in log space)
x <- matrix(1 + rpois(n, lambda = 5), nrow = n / 2, ncol = 2)
# Dithered counts
y <- DitherCounts(x)
```

```{r, echo=FALSE, fig.width=2.5, fig.height=3.0, message=FALSE, warning=FALSE}
# Visualize count distributions
Plots(x, y)
```

### Negative binomial distribution

```{r}
# Number of simulated data points
n <- 30000
# Raw counts (one pseudo count is added to prevent infinite values in log space)
x <- matrix(1 + rnbinom(n, mu = 5, size = 2), nrow = n / 2, ncol = 2)
# Dithered counts
y <- DitherCounts(x)
```

```{r, echo=FALSE, fig.width=2.5, fig.height=3.0, message=FALSE, warning=FALSE}
# Visualize count distributions
Plots(x, y)
```

### Bimodal distribution

```{r}
# Number of simulated data points
n <- 30000
# Raw counts
p <- rep(c(1, 1, 2, 3, 2, 1, 1), length.out = 14)
x <- RandomCounts(n, d = 2, p = p)$x
# Dithered counts
y <- DitherCounts(x)
```

```{r, echo=FALSE, fig.width=2.5, fig.height=3.0, message=FALSE, warning=FALSE}
Plots(x, y)

par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.8, cex.axis = 0.8)
PlotHistograms(x, y, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
# PlotHistograms(x, y = x, bins = 100, log = F, rel = T, xlab = "counts", ylab = "frequency")
legend("topright", legend = c("x", "y"), fill = c("darkgrey", "red"), bty = "n", cex = 0.8)

# p <- knn_density(y, k = 200)
# p <- p / max(p)
# clr.prm <- DefineColorMap(thresholds = c(0, 1), colors = grey(1:0), centered = T)
# plot(
#   y, cex = 0.5, col = MakeColors(p, parameters = clr.prm), xlim = xylim, ylim = xylim,
#   xlab = "y1", ylab = "y2"
# )
m <- cbind(
  rep(1:14, 14),
  rep(1:14, each = 14)
)
d <- p
d <- d[m[, 1]] + d[m[, 2]]
d <- (d / max(d))^1.5
xylim <- range(x, y)
plot(
  m, cex = 0.5, col = grey(1 - d), xlim = xylim, ylim = xylim,
  xlab = "x1", ylab = "x2"
)
h <- BivariateDensity(y, nx = 50, plot = T, xlim = xylim, ylim = xylim, method = "bin", xlab = "y1", ylab = "y2", color.mode = "rank")
```
