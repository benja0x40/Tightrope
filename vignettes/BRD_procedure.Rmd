---
title: "BRD normalization"
author: "Benjamin Leblanc"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{BRD normalization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Helper functions

```{r, include=FALSE}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
ExperimentAnnotations <- function(wks_name, xps = T) {
  tbl <- get(wks_name)$ann[xps, ]
  if(any(grepl("^geo\\.", colnames(tbl)))) {
    skip <- c(
      "experiment", "submission", "study", "sample", "run", "molecule"
    )
  } else {
    skip <- c(
      "project", "SampleNumber", "IsPairedEnd", "Read1", "Read2", "NumReadsPF"
    )
  }
  skip <- c(
    skip, "mapping_command", "basemount.host", "mapping_options", "mapping_index"
  )
  rex <- "^(geo|library_|platform_|instrument_)|(file|path)"
  skip <- colnames(tbl) %in% skip | grepl(rex, colnames(tbl))
  tbl <- tbl[, ! skip]
  tbl
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
InsertAntibody <- function(viz, abd) {
  for(i in 1:length(viz)) {
    viz[[i]] <- gsub("X---X", abd, viz[[i]])
  }
  viz
}
# =============================================================================.
#
# -----------------------------------------------------------------------------.
PlotBRD <- function(brd, core_only = F, legend = T) {
  
  clr.prm <- AutoColorParameters("ry")
  clr.prm$thresholds <- round(clr.prm$thresholds, 2)

  ncl <- brd$parameters$ncl
  grp.clr <- rgb(1, 0.9, 0)
  if(ncl > 1) {
    grp.clr <- c(
      grp.clr, transformColors(SuperRainbow(3), delta.H = 30)[2:ncl]
    )
  }
  if(core_only) {
    grp.prm <- defineGroups(ids = brd$bg_clurank, colors = grp.clr)
  } else {
    grp.clr <- as.vector(
      rbind(transformColors(grp.clr, S.range = 0.5), grp.clr)
    )
    grp.prm <- defineGroups(
      ids = 2 * rep(brd$bg_clurank, each = 2) - c(1, 0), colors = grp.clr
    )
  }
  
  spc <- 0
  if(legend) spc <- c(0, -0.15)
  lim <- xylim(brd$dred$projection[, 1:2], spacing = spc, margin = 0.1)
  
  o <- order(brd$dred$density)
  
  # Plot Count Density after Dithering and Dimensionality Reduction
  with(
    brd$dred, plot_samples(
      projection[o, ], xlim = lim$x, ylim = lim$y,
      col = colorize(density[o], mode = "rank", colors = "ry"),
      main = "density"
    )
  )
  if(legend) {
    colorLegend(
      "b", horiz = T, size = c(70, 3), parameters = clr.prm,
      ticks = 0:4/4, tick.pos = -1, cex = 0.75
    )
  }
  # Plot CDaDaDR and overlay subsets
  with(
    brd$dred, plot_samples(
      projection[o, ], xlim = lim$x, ylim = lim$y,
      col = colorize(density[o], mode = "rank"),
      main = "clustering"
    )
  )
  if(core_only) {
    with(
      brd$subsets, plot_samples(
        x[core], grp = cluster[core], grp.prm = grp.prm, alpha = 0.1, add = T
      )
    )
  } else {
    with(
      brd$subsets, plot_samples(
        x, grp = 2 * cluster + core - 1, grp.prm = grp.prm, alpha = 0.1, add = T
      )
    )
  }
  if(legend) {
    legend(
      "bottomleft", legend = "best candidate",
      fill = grp.prm$colors[1 + core_only], cex = 0.75, bty = 'n'
    )
  }
}
```

### Initializations

```{r, include=FALSE}
# #############################################################################.
suppressPackageStartupMessages(library(Tightrope))
# =============================================================================.
#
# -----------------------------------------------------------------------------.
CFG_DTS <- list()
```

#### Dataset selection

```{r}
# ESC_BRD, NSC_K27M, E14_EPZ, Lu_et_al
load_dataset   <- "E14_EPZ"
target_dataset <- "E14_EPZ"

# H3K27me3, H3K27me2, H3K27me1, Suz12, H3K36me3
antibody <- "H3K27me1"
```

#### Glopal settings

```{r}
dither  <- 5
zscore  <- T
mincs   <- 300
```

### Collection of spike-in datasets

```{r, include=FALSE}
# =============================================================================.
if(any(c("ESC_BRD", "ALL") %in% load_dataset)) {
  ESC_BRD <- list()
  
  data_path <- "/Volumes/USB16GB/LT_WORKS/NextSeq_ESC_BRD_R1_TEST/"
  ESC_BRD$R1 <- list(
    ann = read.delim(
      paste0(data_path, "_LittleThumb_/datasets/bowtie2_mm10.txt"),
      comment.char = "#", stringsAsFactors = F
    ),
    CNT = readRDS(paste0(data_path, "_RDATA_/ROI.CNT.rdata"))
  )
  rm(data_path)
  
  data_path <- "/Volumes/USB16GB/LT_WORKS/NextSeq_ESC_BRD_R2_TEST/"
  ESC_BRD$R2 <- list(
    ann = read.delim(
      paste0(data_path, "_LittleThumb_/datasets/bowtie2_mm10.txt"),
      comment.char = "#", stringsAsFactors = F
    ),
    CNT = readRDS(paste0(data_path, "_RDATA_/ROI.CNT.rdata"))
  )
  rm(data_path)
  
  # Reshape to join replicates
  ESC_BRD <- list(
    name = "ESC_BRD",
    antibody = antibody,
    data_path = "/Volumes/USB16GB/LT_WORKS/NextSeq_ESC_BRD_RDATA/",
    ann = rbind(
      ESC_BRD$R1$ann,
      ESC_BRD$R2$ann
    ),
    CNT = with(ESC_BRD, JoinColumns(R1$CNT, R2$CNT))
  )

  if(! with(ESC_BRD, all(ann$lt_id == colnames(CNT$GN)))) {
    stop("Inconsistent annotation of samples in ESC_BRD")
  }
  # ---------------------------------------------------------------------------.
  ESC_BRD <- list2env(ESC_BRD)
}

# =============================================================================.
if(any(c("NSC_K27M", "ALL") %in% load_dataset)) {
  data_path <- "/Volumes/USB16GB/LT_WORKS/NextSeq_K27M_spike_in/"
  NSC_K27M <- list(
    name = "NSC_K27M",
    antibody = antibody,
    data_path = paste0(data_path, "_RDATA_/"),
    ann = read.delim(
      paste0(data_path, "_LittleThumb_/datasets/bowtie2_mm10.txt"),
      comment.char = "#", stringsAsFactors = F
    ),
    CNT = readRDS(paste0(data_path, "_RDATA_/ROI.CNT.rdata"))
  )
  rm(data_path)
  
  if(! with(NSC_K27M, all(ann$lt_id == colnames(CNT$GN)))) {
    stop("Inconsistent annotation of samples in NSC_K27M")
  }
  # ---------------------------------------------------------------------------.
  NSC_K27M <- list2env(NSC_K27M)
}

# =============================================================================.
if(any(c("E14_EPZ", "ALL") %in% load_dataset)) {
  data_path <- "/Volumes/USB16GB/LT_WORKS/NextSeq_E14EPZ/"
  E14_EPZ <- list(
    name = "E14_EPZ",
    antibody = antibody,
    data_path = paste0(data_path, "_RDATA_/"),
    ann = read.delim(
      paste0(data_path, "_LittleThumb_/datasets/bowtie2_mm10.txt"),
      comment.char = "#", stringsAsFactors = F
    ),
    CNT = readRDS(paste0(data_path, "_RDATA_/ROI.CNT.rdata"))
  )
  rm(data_path)
  
  if(! with(E14_EPZ, all(ann$lt_id == colnames(CNT$GN)))) {
    stop("Inconsistent annotation of samples in E14_EPZ")
  }
  # ---------------------------------------------------------------------------.
  E14_EPZ <- list2env(E14_EPZ)
}

# =============================================================================.
if(any(c("Lu_et_al", "ALL") %in% load_dataset)) {
  data_path <- "/Volumes/USB16GB/LT_WORKS/GSE63195_Lu_et_al_2016/"
  Lu_et_al <- list(
    name = "Lu_et_al",
    antibody = antibody,
    data_path = paste0(data_path, "_RDATA_/"),
    ann = read.delim(
      paste0(data_path, "_LittleThumb_/datasets/bowtie2_mm10.txt"),
      comment.char = "#", stringsAsFactors = F
    ),
    CNT = readRDS(paste0(data_path, "_RDATA_/ROI.CNT.rdata"))
  )
  rm(data_path)
  
  if(! with(Lu_et_al, all(ann$lt_id == colnames(CNT$GN)))) {
    stop("Inconsistent annotation of samples in Lu_et_al")
  }
  # ---------------------------------------------------------------------------.
  Lu_et_al <- list2env(Lu_et_al)
}
```

#### 1. ESC_BRD

SUZ12 WT + KO cell mix experiments in mouse ESCs.

```{r, include=FALSE}
wks_name <- "ESC_BRD"
# =============================================================================.
if(exists(wks_name)) {
  wks <- get(wks_name)
  CFG_DTS[[wks_name]] <- list(
    xps = wks$ann$antibody %in% c(antibody, "Input"), # & replicate %in% c("R1", "R2")
    viz = list(
      c("ESC_Input_0_R1", "ESC_X---X_100_R1", "ESC_X---X_10_R1", "ESC_X---X_0_R1"),
      c("ESC_Input_0_R2", "ESC_X---X_100_R2", "ESC_X---X_10_R2", "ESC_X---X_0_R2"),
      
      c("ESC_X---X_100_R1", "ESC_X---X_10_R1"),
      c("ESC_X---X_100_R2", "ESC_X---X_10_R2"),
      c("ESC_Input_0_R1",      "ESC_Input_0_R2")
    ),
    layout  = matrix(1:9, 3, 3, byrow = T),
    nxp     = 0,
    rex     = "Input",
    ref_roi = c(H3K27me3 = "GN_ENS", Suz12 = "CGI_UCSC"),
    smobs   = c(H3K27me3 = T,   Suz12 = F),
    cvt     = NA,
    npc     = 2,
    knn     = 300,
    bdt     = c(0.5, 0.05), # c(H3K27me3 = 0.8, Suz12 = .95),
    ncl     = c(H3K27me3 =   2, Suz12 =   1)
  )
  for(opt in c("ref_roi", "smobs", "ncl")) {
    CFG_DTS[[wks_name]][[opt]] <- CFG_DTS[[wks_name]][[opt]][antibody]
  }

  CFG_DTS[[wks_name]]$viz <- InsertAntibody(CFG_DTS[[wks_name]]$viz, antibody)
  CFG_DTS[[wks_name]]$nxp <- sum(CFG_DTS[[wks_name]]$xps)
  # ---------------------------------------------------------------------------.
  rm(wks)
}
```

```{r, echo=FALSE, results='asis'}
if(exists(wks_name)) {
  knitr::kable(ExperimentAnnotations(wks_name, xps = CFG_DTS[[wks_name]]$xps))
  rm(wks_name)
}
```

#### 2. NSC_K27M

H3WT versus K27M experiments in mouse NSCs.

```{r, include=FALSE}
wks_name <- "NSC_K27M"
# =============================================================================.
if(exists(wks_name)) {
  wks <- get(wks_name)
  CFG_DTS[[wks_name]] <- list(
    xps = with(
      wks$ann, antibody %in% c("H3K27me3", "Input") & replicate %in% c("R1", "R2")
    ),
    viz = list(
      c("H3WT_DMSO_H3K27me3_R1", "K27M_DMSO_H3K27me3_R1", "H3WT_EPZ_H3K27me3_R1"),
      c("H3WT_DMSO_Input_R1",    "H3WT_DMSO_H3K27me3_R1", "K27M_DMSO_H3K27me3_R1", "H3WT_EPZ_H3K27me3_R1"),
      
      c("H3WT_DMSO_H3K27me3_R2", "K27M_DMSO_H3K27me3_R2", "H3WT_EPZ_H3K27me3_R2"),
      c("H3WT_DMSO_Input_R2",    "H3WT_DMSO_H3K27me3_R2", "K27M_DMSO_H3K27me3_R2", "H3WT_EPZ_H3K27me3_R2"),

      c("H3WT_DMSO_H3K27me3_R1", "H3WT_DMSO_H3K27me3_R2"),
      c("K27M_DMSO_H3K27me3_R1", "K27M_DMSO_H3K27me3_R2"),
      c("H3WT_EPZ_H3K27me3_R1",  "H3WT_EPZ_H3K27me3_R2"),
      c("H3WT_DMSO_Input_R1",    "H3WT_DMSO_Input_R2")
    ),
    layout  = matrix(1:9, 3, 3, byrow = T),
    nxp     = 0,
    rex     = "Input",
    ref_roi = "GN_ENS",
    smobs   = T,
    cvt     = NA,
    npc     = 2,
    knn     = 300,
    bdt     = c(0.5, 0.05),
    ncl     = 1
  )
  CFG_DTS[[wks_name]]$nxp <- sum(CFG_DTS[[wks_name]]$xps)
  # ---------------------------------------------------------------------------.
  rm(wks)
}
```

```{r, echo=FALSE, results='asis'}
if(exists(wks_name)) {
  knitr::kable(ExperimentAnnotations(wks_name, xps = CFG_DTS[[wks_name]]$xps))
}
rm(wks_name)
```

#### 3. E14_EPZ

EZH2 inhibitor washout experiments in mouse ESCs.

```{r, include=FALSE}
wks_name <- "E14_EPZ"
# =============================================================================.
if(exists(wks_name)) {
  wks <- get(wks_name)
  CFG_DTS[[wks_name]] <- list(
    xps = wks$ann$antibody %in% antibody,
    viz = list(
      c("X---X_E14", "X---X_7d", "X---X_8h", "X---X_24h")
    ),
    layout  = matrix(1:9, 3, 3, byrow = T),
    nxp     = 0,
    rex     = "_7d$",
    ref_roi = c(H3K27me3 = "GN_ENS", H3K27me2 = "CGI_UCSC", H3K27me1 = "CGI_UCSC", Suz12 = "CGI_UCSC"),
    smobs   = c(H3K27me3 = F, H3K27me2 = F, H3K27me1 = F, Suz12 = F),
    cvt     = NA,
    npc     = 2,
    knn     = 300,
    bdt     = c(0.5, 0.05),
    # bdt     = c(H3K27me3 = .98, H3K27me2 = .90, H3K27me1 = .90, Suz12 = .95),
    ncl     = c(H3K27me3 =   1, H3K27me2 =   2, H3K27me1 =   2, Suz12 =   1)
  )
  for(opt in c("ref_roi", "smobs", "ncl")) {
    CFG_DTS[[wks_name]][[opt]] <- CFG_DTS[[wks_name]][[opt]][antibody]
  }

  CFG_DTS[[wks_name]]$viz <- InsertAntibody(CFG_DTS[[wks_name]]$viz, antibody)
  CFG_DTS[[wks_name]]$nxp <- sum(CFG_DTS[[wks_name]]$xps)
  # ---------------------------------------------------------------------------.
  rm(wks)
}
```

```{r, echo=FALSE, results='asis'}
if(exists(wks_name)) {
  knitr::kable(ExperimentAnnotations(wks_name, xps = CFG_DTS[[wks_name]]$xps))
}
rm(wks_name)
```

#### 4. Lu_et_al

H3WT versus K36M experiments from Lu et al., 2016.

```{r, include=FALSE}
wks_name <- "Lu_et_al"
# =============================================================================.
if(exists(wks_name)) {
  wks <- get(wks_name)
  CFG_DTS[[wks_name]] <- list(
    xps = wks$ann$antibody %in% c(antibody, "Input"),
    viz = list(
      c("H3WT_X---X", "K36M_X---X"),
      c("H3WT_Input", "H3WT_X---X", "K36M_X---X")
    ),
    layout  = matrix(1:9, 3, 3, byrow = T),
    nxp     = 0,
    rex     = "Input",
    ref_roi = "GN",
    smobs   = T,
    cvt     = NA,
    npc     = 2, 
    knn     = 300,
    bdt     = c(0.5, 0.05),
    # bdt     = c(H3K36me3 = .95, H3K27me3 = .95),
    ncl     = c(H3K36me3 =   1, H3K27me3 =   1)
  )
  for(opt in c("ncl")) {
    CFG_DTS[[wks_name]][[opt]] <- CFG_DTS[[wks_name]][[opt]][antibody]
  }
  
  CFG_DTS[[wks_name]]$viz <- InsertAntibody(CFG_DTS[[wks_name]]$viz, antibody)
  CFG_DTS[[wks_name]]$nxp <- sum(CFG_DTS[[wks_name]]$xps)
  # ---------------------------------------------------------------------------.
  rm(wks)
}
```

```{r, echo=FALSE, results='asis'}
if(exists(wks_name)) {
  knitr::kable(ExperimentAnnotations(wks_name, xps = CFG_DTS[[wks_name]]$xps))
}
rm(wks_name)
```

### BRD procedure

#### Dataset dependent settings

```{r, echo=FALSE, results='asis'}
tbl <- t(sapply(CFG_DTS, "[", -(1:3)))
knitr::kable(tbl)
rm(tbl)
```

#### Extraction of count data

```{r, include=FALSE}
# Select dataset to be analysed
cfg  <- CFG_DTS[[target_dataset]]

# Raw counts
wks <- get(target_dataset)
cnt <- with(cfg, wks$CNT[[ref_roi]][, xps])

# Name of all experiments and controls
experiments <- colnames(cnt)
controls    <- experiments[grepl(cfg$rex, experiments, perl = T)]
```

#### BRD estimation

```{r, echo=FALSE}
brd <- with(
  cfg, BRD(
    cnt, controls = controls, dither = dither,
    smobs = smobs, cvt  = cvt , npc = npc, zscore = zscore,
    knn = knn, bdt = bdt, ncl = ncl, mincs = mincs
  ) 
)
message("status: ", brd$status)
```

#### Saved results

```{r, include=FALSE}
# Reshape dataset to match target experiments
wks$experiments <- experiments
wks$controls    <- controls
wks$CFG         <- cfg
wks$CNT         <- ExtractColumns(wks$CNT, experiments)
wks$ann         <- with(wks, ann[match(experiments, ann$lt_id), ])
rownames(wks$ann) <- NULL

# Include BRD results
wks$BRD <- c(
  list(ref_roi = cfg$ref_roi), # regions used for BRD estimation
  brd
)

# Save RData
saveRDS(
  wks, paste0(
    wks$data_path, cfg$ref_roi, "_", target_dataset, "_", antibody, ".RData"
  )
)
```

### Controls

#### Dimensionality reduction

```{r, echo=FALSE, results='asis'}
tbl <- as.data.frame(brd$dred$status[1:4])
knitr::kable(data.frame(tbl))
```

```{r, echo=FALSE, fig.height=3.5, fig.width=5, dpi=300}
par(mar = c(5, 4, 3, 1), pch = 20, cex.main = 0.9, cex.lab = 0.8, cex.axis = 0.8)
clr <- with(brd$dred$status, 1:original <= reduced)
clr <- ifelse(clr, grey(0.5), rgb(0.5, 0, 0))
with(
  brd$dred$status,
  barplot(cvpc, col = clr, border = clr, ylab = "% variance", las = 2)
)
```

#### Clustering statistics

```{r, echo=FALSE, results='asis'}
knitr::kable(brd$populations)
```

### Figures

```{r, include=FALSE}
```

#### Density analysis

```{r, echo=FALSE, fig.width=3, fig.height=3.5, dpi=300}
# layout 1 x 2 => 5.28 x 2.97
# layout 2 x 2 => 5.28 x 5.94
# layout 6 x 2 => 5.28 x 8.91

# layout(matrix(1:2, 1, 2, byrow = T))
par(mar = c(5, 4, 3, 1), pch = 20, cex.main = 0.9, cex.lab = 0.8, cex.axis = 0.8)
PlotBRD(brd, core_only = F, legend = T)
```

#### Scaling factors

```{r, echo=FALSE, fig.height=3.5, fig.width=3, dpi=300}
# layout 1 x 1 => 2.64 x 2.97
# layout 1 x 2 => 5.28 x 2.97
# layout 2 x 2 => 5.28 x 5.94

# layout(cfg$layout)
par(mar = c(5, 4, 3, 1), pch = 20, cex.main = 0.9, cex.lab = 0.8, cex.axis = 0.8)

cnt <- cnt[brd$nonzero, ]

for(cmp in cfg$viz) {
  for(lbl in cmp[-1]) {
    
    idx <- match(c(cmp[1], lbl), experiments)
    d <- knn_density(brd$log2counts[, idx], k = cfg$knn)
    o <- order(d)
    plot_samples(
      log2(cnt)[o, ], idx, col = colorize(d[o], mode = "rank")
    )
    plot_samples(
      log2(cnt)[brd$bg_members, ], idx,
      col = rgb(1, 0.9, 0), alpha = 0.1, add = T
    )
    plot_sources_2D(
      list(brd$bg_theta), components = idx,
      clr = rgb(1, 0, 0), lwd = 1
    )
    abline(
      a = diff(brd$bg_theta$mu[idx]), b = 1,
      col = rgb(1, 0.5, 0), lwd = 1.5
    )
  }
}
```

### END

```{r, eval=FALSE, include=FALSE}

# cgi <- E14_EPZ$CNT$CGI_UCSC
# cgi <- cgi[FiniteValues(log2(cgi)), colnames(nrm)]
# cgi <- log2(DitherCounts(cgi))
# cgi <- t(t(cgi) + scaling)
# 
# layout(matrix(1:2, 1, 2))
# par(mar = c(10, 4, 3, 1), pch = 20, cex.lab = 0.9, cex.axis = 0.9)
# boxplot(nrm, las = 2)
# abline(h = median(nrm[, 1]))
# boxplot(cgi, las = 2)
# abline(h = median(cgi[, 1]))
# 
# o <- order(cgi[, 1], decreasing = T)
# m <- apply(cgi[o, ], 2, runmed, k = 255)
# n <- ncol(m) - 2
# clr <- c("black", rgb(0:n/n, 0.5*n:0/n, n:0/n))
# n <- ncol(m)
# 
# layout(matrix(1:4, 2, 2, byrow = T))
# par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.9, cex.axis = 0.9)
# empty.plot(xlim = c(1, nrow(m)), ylim = range(m))
# for(i in 1:n) points(m[, i], type = "l", col = clr[i])



# me3 <- ldc[, grepl("H3K27me3", colnames(ldc))]
# me2 <- ldc[, grepl("H3K27me2", colnames(ldc))]
# me1 <- ldc[, grepl("H3K27me1", colnames(ldc))]
# 
# x <- me1
# x <- x - rowMeans(x)
# 
# layout(matrix(1:4, 2, 2, byrow = T))
# par(mar = c(5, 4, 3, 1), pch = 20, cex.lab = 0.9, cex.axis = 0.9)
# 
# pcp <- prcomp(x, retx = T, center = T, scale. = T)
# pcp <- pcp$x[, 1:2]
# src <- icafast(x, nc = 2, alg = "def")
# icp <- src$Y[, 1:2]
# src <- src$S[, 1:2]
# 
# pcd <- knn_density(pcp, k = 200)
# icd <- knn_density(icp, k = 200)
# scd <- knn_density(src, k = 200)
# 
# plot_samples(pcp, col = colorize(pcd, mode = "rank", colors = "ry"))
# plot_samples(icp, col = colorize(icd, mode = "rank", colors = "ry"))
# plot_samples(src, col = colorize(scd, mode = "rank", colors = "ry"))


```

